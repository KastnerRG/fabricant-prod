- name: Install microk8s Snap Package
  become: true
  community.general.snap:
    name: microk8s
    state: present
    classic: true
- name: Add user 'fabricant-admin' to 'microk8s'
  become: true
  user:
    name: fabricant-admin
    groups: microk8s
    append: yes
- name: Recursively change ownership of ~/.kube to fabricant-admin
  become: true
  ansible.builtin.file:
    path: /home/fabricant-admin/.kube
    state: directory
    owner: fabricant-admin
    group: fabricant-admin
    recurse: yes

- name: Install microceph Snap Package
  become: true
  community.general.snap:
    name: microceph
    state: present
- name: Configure global osd_pool_default_size 2
  become: true
  ansible.builtin.command:
    cmd: microceph.ceph config set global osd_pool_default_size 2
- name: Configure mgr mgr_standby_modules false
  become: true
  ansible.builtin.command:
    cmd: microceph.ceph config set mgr mgr_standby_modules false
- name: Configure mgr mgr_standby_modules false
  become: true
  ansible.builtin.command:
    cmd: microceph.ceph config set osd osd_crush_chooseleaf_type 0

- name: Enable microk8s addons
  become: true
  ansible.builtin.command:
    cmd: microk8s enable dns dashboard registry rook-ceph
